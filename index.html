<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BH Merger Waveform Explorer (Pedagogical)</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root { --bg:#0b0f17; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
           background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:0 auto; padding:18px; display:grid; gap:14px; grid-template-columns: 360px 1fr; }
    .card { background:var(--panel); border:1px solid rgba(255,255,255,0.06); border-radius:14px; padding:14px; }
    h1 { font-size:18px; margin:0 0 10px; }
    .row { display:flex; justify-content:space-between; gap:10px; align-items:center; margin:10px 0; }
    label { font-size:13px; color:var(--muted); }
    input[type="range"] { width: 190px; }
    select { width: 190px; background: rgba(255,255,255,0.06); color: var(--text); border:1px solid rgba(255,255,255,0.12);
             border-radius:10px; padding:6px 8px; }
    .val { font-variant-numeric: tabular-nums; font-size:13px; color:var(--text); min-width:90px; text-align:right; }
    .note { color:var(--muted); font-size:12px; line-height:1.35; }
    button { cursor:pointer; border:1px solid rgba(255,255,255,0.12); background:transparent; color:var(--text);
             border-radius:10px; padding:8px 10px; }
    button:hover { border-color: rgba(96,165,250,0.6); }
    button:disabled { opacity:0.55; cursor:not-allowed; }
    .small { font-size:12px; color:var(--muted); }
    @media (max-width: 900px) { .wrap { grid-template-columns: 1fr; } input[type="range"], select { width: 100%; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>BH Merger Waveform Explorer</h1>

      <div class="row">
        <label for="m1">m1 (M☉)</label>
        <input id="m1" type="range" min="5" max="100" value="35" step="1">
        <div class="val" id="m1v"></div>
      </div>

      <div class="row">
        <label for="m2">m2 (M☉)</label>
        <input id="m2" type="range" min="5" max="100" value="30" step="1">
        <div class="val" id="m2v"></div>
      </div>

      <div class="row">
        <label for="dist">Distance (Mpc)</label>
        <input id="dist" type="range" min="50" max="2000" value="400" step="10">
        <div class="val" id="distv"></div>
      </div>

      <div class="row">
        <label for="inc">Inclination ι (deg)</label>
        <input id="inc" type="range" min="0" max="90" value="30" step="1">
        <div class="val" id="incv"></div>
      </div>

      <div class="row">
        <label for="tc">Coalescence time tc (s)</label>
        <input id="tc" type="range" min="0.2" max="3.8" value="2.6" step="0.01">
        <div class="val" id="tcv"></div>
      </div>

      <div class="row">
        <label for="tau">Ringdown τ (ms)</label>
        <input id="tau" type="range" min="1" max="40" value="10" step="0.5">
        <div class="val" id="tauv"></div>
      </div>

      <div class="row">
        <label for="dur">Window length (s)</label>
        <input id="dur" type="range" min="1.0" max="8.0" value="4.0" step="0.1">
        <div class="val" id="durv"></div>
      </div>

      <div class="row">
        <label for="fs">Sample rate (Hz)</label>
        <input id="fs" type="range" min="256" max="4096" value="1024" step="256">
        <div class="val" id="fsv"></div>
      </div>

      <div class="row">
        <label for="detector">Detector preset</label>
        <select id="detector">
          <option value="custom">Custom</option>
          <option value="aligo">aLIGO-ish (20–1024 Hz)</option>
          <option value="et">ET-ish (3–2048 Hz)</option>
          <option value="badlf">Bad low-f (40–1024 Hz)</option>
          <option value="lisa">LISA-ish (0.001–0.1 Hz) (toy)</option>
        </select>
        <div class="val"></div>
      </div>

      <div class="row">
        <label for="flow">Detector f_low (Hz)</label>
        <input id="flow" type="range" min="1" max="100" value="20" step="1">
        <div class="val" id="flowv"></div>
      </div>

      <div class="row">
        <label for="fhigh">Detector f_high (Hz)</label>
        <input id="fhigh" type="range" min="50" max="2000" value="512" step="1">
        <div class="val" id="fhighv"></div>
      </div>

      <hr style="border:0; border-top:1px solid rgba(255,255,255,0.08); margin:14px 0;">

      <div class="row">
        <label for="audsrc">Audio source</label>
        <select id="audsrc">
          <option value="det">Detector-band</option>
          <option value="raw">Raw</option>
        </select>
        <div class="val"></div>
      </div>

      <div class="row">
        <label for="speed">Audio speed</label>
        <input id="speed" type="range" min="1" max="30" value="10" step="1">
        <div class="val" id="speedv"></div>
      </div>

      <div class="row" style="margin-top:6px;">
        <button id="play">Play</button>
        <button id="stop" disabled>Stop</button>
        <div class="val" id="audiostate"></div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button id="reset">Reset</button>
        <div class="small" id="derived"></div>
      </div>

      <p class="note">
        Model: a fast, browser-friendly <b>pedagogical IMR-like waveform</b> (inspiral chirp + smooth merger + damped ringdown).
        “Detector view” applies a simple <b>hard bandpass</b> in frequency space to emulate limited bandwidth.
        Audio uses a simple resampling + normalization for an audible “chirp” impression.
      </p>
    </div>

    <div class="card">
      <div id="plot" style="height:520px;"></div>
      <div class="note">
        Tip: heavier masses → shorter / “lower pitched”. Raise f_low → you lose early inspiral. Lower f_high → merger/ringdown is smoothed away.
        For audio: increase “speed” to make it more audible.
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- UI helpers ----------
  const $ = (id) => document.getElementById(id);
  const sliders = ["m1","m2","dist","inc","tc","tau","dur","fs","flow","fhigh"].map($);
  const setVal = (id, txt) => $(id+"v").textContent = txt;

  const defaults = {
    m1:35, m2:30, dist:400, inc:30, tc:2.6, tau:10, dur:4.0, fs:1024,
    detector:"aligo", flow:20, fhigh:512,
    audsrc:"det", speed:10
  };

  // ---------- Physics-ish helpers (pedagogical) ----------
  const PI = Math.PI;
  const G = 6.67430e-11;                 // SI
  const c = 299792458;                   // SI
  const MSUN = 1.98847e30;               // kg

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  function chirpMass(m1, m2) {
    const M = m1 + m2;
    const eta = (m1*m2)/(M*M);
    return M * Math.pow(eta, 3/5);
  }

  function symmetricMassRatio(m1, m2) {
    const M = m1 + m2;
    return (m1*m2)/(M*M);
  }

  function fISCO(m1, m2) {
    const M = (m1+m2) * MSUN;
    return (1/(6*Math.sqrt(6)*PI)) * (c*c*c)/(G*M);
  }

  function smoothstep(x) { return x*x*(3-2*x); }

  function generateWaveform(params) {
    const {m1,m2,distMpc,incDeg,tc,tauMs,dur,fs} = params;

    const n = Math.floor(dur * fs);
    const dt = 1/fs;

    const eta = symmetricMassRatio(m1,m2);
    const inc = incDeg * PI/180;

    const F = (1 + Math.cos(inc)*Math.cos(inc)) / 2;

    const f_isco = fISCO(m1,m2);
    const f_merge = 0.6 * f_isco;
    const f_ring = 0.8 * f_isco;

    // arbitrary visualization scaling
    const A0 = 5e-22;
    const K = A0 * F * (400/distMpc);

    const tau = (tauMs/1000.0);
    const omega_ring = 2*PI*f_ring;

    const t = new Array(n);
    const h = new Array(n);

    let phi = 0;
    let prev_f = 30;

    for (let i=0;i<n;i++) {
      const ti = i*dt;
      t[i] = ti - tc;

      const dtc = (tc - ti);

      if (dtc > 0) {
        const dtc0 = dur;
        const f_start = 25;
        let f = f_start * Math.pow(dtc / dtc0, -3/8);
        f = clamp(f, 15, f_merge);

        phi += 2*PI * 0.5*(f + prev_f) * dt;
        prev_f = f;

        const amp = K * Math.pow(f/50, 2/3);

        const x = clamp(1 - dtc/0.25, 0, 1);
        const boost = 1 + 1.8*smoothstep(x);
        h[i] = boost * amp * Math.cos(phi);
      } else {
        const tr = -dtc;
        const amp0 = K * Math.pow(f_merge/50, 2/3) * 2.8;
        h[i] = amp0 * Math.exp(-tr/tau) * Math.cos(omega_ring*tr + phi);
      }
    }

    return {
      t, h,
      derived: {
        Mc_solar: chirpMass(m1,m2),
        eta,
        f_isco,
        f_merge,
        f_ring
      }
    };
  }

  // ---------- Simple FFT bandpass (hard cutoff) ----------
  function nextPow2(n){ let p=1; while(p<n) p<<=1; return p; }

  function fftRadix2(re, im, inverse=false){
    const n = re.length;

    for (let i=1, j=0; i<n; i++){
      let bit = n >> 1;
      for (; j & bit; bit >>= 1) j ^= bit;
      j ^= bit;
      if (i < j){
        [re[i], re[j]] = [re[j], re[i]];
        [im[i], im[j]] = [im[j], im[i]];
      }
    }

    for (let len=2; len<=n; len<<=1){
      const ang = (inverse ? 2 : -2) * Math.PI / len;
      const wlen_re = Math.cos(ang);
      const wlen_im = Math.sin(ang);

      for (let i=0; i<n; i+=len){
        let w_re = 1, w_im = 0;
        for (let j=0; j<len/2; j++){
          const u_re = re[i+j], u_im = im[i+j];
          const v_re = re[i+j+len/2]*w_re - im[i+j+len/2]*w_im;
          const v_im = re[i+j+len/2]*w_im + im[i+j+len/2]*w_re;

          re[i+j] = u_re + v_re;
          im[i+j] = u_im + v_im;
          re[i+j+len/2] = u_re - v_re;
          im[i+j+len/2] = u_im - v_im;

          const nw_re = w_re*wlen_re - w_im*wlen_im;
          const nw_im = w_re*wlen_im + w_im*wlen_re;
          w_re = nw_re; w_im = nw_im;
        }
      }
    }

    if (inverse){
      for (let i=0;i<n;i++){ re[i]/=n; im[i]/=n; }
    }
  }

  function bandpassHard(x, fs, fLow, fHigh){
    const n0 = x.length;
    const n = nextPow2(n0);

    const re = new Array(n).fill(0);
    const im = new Array(n).fill(0);
    for (let i=0;i<n0;i++) re[i] = x[i];

    fftRadix2(re, im, false);

    const df = fs / n;
    const kLow  = Math.floor(fLow / df);
    const kHigh = Math.ceil (fHigh / df);

    for (let k=0;k<n;k++){
      const kmag = (k <= n/2) ? k : (n - k);
      const keep = (kmag >= kLow && kmag <= kHigh);
      if (!keep){ re[k]=0; im[k]=0; }
    }

    fftRadix2(re, im, true);
    return re.slice(0, n0);
  }

  // ---------- Audio (Web Audio API) ----------
  let audioCtx = null;
  let currentSource = null;

  function stopAudio(){
    try { if (currentSource) currentSource.stop(); } catch(e) {}
    currentSource = null;
    $("stop").disabled = true;
    $("play").disabled = false;
    $("audiostate").textContent = "";
  }

  function toAudioBuffer(x, fs, speed){
    // speed > 1 compresses time (higher pitch, shorter duration)
    const outFs = 48000;
    const factor = (outFs / fs) * speed;
    const outN = Math.max(1, Math.floor(x.length * factor));

    // linear resampling
    const y = new Float32Array(outN);
    for (let i=0;i<outN;i++){
      const src = i / factor;
      const j = Math.floor(src);
      const a = src - j;
      const x0 = x[Math.min(j, x.length-1)];
      const x1 = x[Math.min(j+1, x.length-1)];
      y[i] = (1-a)*x0 + a*x1;
    }

    // normalize + 10 ms fade to avoid clicks
    let mx = 0;
    for (let i=0;i<y.length;i++) mx = Math.max(mx, Math.abs(y[i]));
    const gain = mx > 0 ? 0.9/mx : 1.0;
    const fade = Math.min(800, Math.floor(0.01*outFs)); // 10ms at 48kHz
    for (let i=0;i<y.length;i++){
      let w = 1;
      if (i < fade) w = i/fade;
      if (i > y.length-1-fade) w = (y.length-1-i)/fade;
      y[i] = y[i] * gain * w;
    }

    return { y, outFs };
  }

  function playAudio(x, fs){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Must be triggered by user gesture (button click) — OK.
    stopAudio();

    const speed = parseInt($("speed").value, 10) || 10;
    const { y, outFs } = toAudioBuffer(x, fs, speed);

    const buf = audioCtx.createBuffer(1, y.length, outFs);
    buf.copyToChannel(y, 0, 0);

    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(audioCtx.destination);
    src.onended = () => {
      // only reset if this is still the active source
      if (currentSource === src) stopAudio();
    };
    src.start();

    currentSource = src;
    $("stop").disabled = false;
    $("play").disabled = true;
    $("audiostate").textContent = "playing…";
  }

  // ---------- Plot + logic ----------
  let initialized = false;

  const detectorPresets = {
    custom: null,
    aligo: { flow: 20,  fhigh: 1024 },
    et:    { flow: 3,   fhigh: 2048 },
    badlf: { flow: 40,  fhigh: 1024 },
    // LISA out of scope; kept as outreach “contrast”
    lisa:  { flow: 1,   fhigh: 10 }
  };

  function applyPresetIfNeeded() {
    const sel = $("detector").value;
    const preset = detectorPresets[sel];
    if (!preset) return;

    $("flow").value = String(preset.flow);

    const fs = parseInt($("fs").value, 10);
    const nyq = 0.5 * fs;
    const fhigh = Math.min(preset.fhigh, Math.max(51, Math.floor(nyq - 1)));
    $("fhigh").value = String(fhigh);
  }

  function getParams() {
    let m1 = parseFloat($("m1").value);
    let m2 = parseFloat($("m2").value);
    if (m2 > m1) { const tmp=m1; m1=m2; m2=tmp; }
    return {
      m1, m2,
      distMpc: parseFloat($("dist").value),
      incDeg: parseFloat($("inc").value),
      tc: parseFloat($("tc").value),
      tauMs: parseFloat($("tau").value),
      dur: parseFloat($("dur").value),
      fs: parseInt($("fs").value, 10),
      flowHz: parseFloat($("flow").value),
      fhighHz: parseFloat($("fhigh").value),
      detector: $("detector").value
    };
  }

  function updateLabels(p, d) {
    setVal("m1", `${p.m1.toFixed(0)}`);
    setVal("m2", `${p.m2.toFixed(0)}`);
    setVal("dist", `${p.distMpc.toFixed(0)}`);
    setVal("inc", `${p.incDeg.toFixed(0)}`);
    setVal("tc", `${p.tc.toFixed(2)}`);
    setVal("tau", `${p.tauMs.toFixed(1)}`);
    setVal("dur", `${p.dur.toFixed(1)}`);
    setVal("fs", `${p.fs}`);
    setVal("flow", `${p.flowHz.toFixed(0)}`);
    setVal("fhigh", `${p.fhighHz.toFixed(0)}`);
    $("speedv").textContent = `${$("speed").value}×`;

    $("derived").innerHTML =
      `Mc=${d.Mc_solar.toFixed(2)} M☉ · η=${d.eta.toFixed(3)}<br>` +
      `fISCO≈${d.f_isco.toFixed(0)} Hz · fmerge≈${d.f_merge.toFixed(0)} Hz`;
  }

  function render() {
    if ($("detector").value !== "custom") applyPresetIfNeeded();

    const p = getParams();

    const nyq = 0.5 * p.fs;
    p.fhighHz = Math.min(p.fhighHz, nyq - 1);
    p.flowHz  = Math.max(1, Math.min(p.flowHz, p.fhighHz - 1));

    const {t, h, derived} = generateWaveform(p);
    const h_det = bandpassHard(h, p.fs, p.flowHz, p.fhighHz);

    // store for audio
    window._lastWave = { h, h_det, fs: p.fs };

    updateLabels(p, derived);

    const traces = [
      { x: t, y: h,     mode: "lines", name: "Raw (source)",
        hovertemplate: "t=%{x:.4f} s<br>h=%{y:.3e}<extra>raw</extra>" },
      { x: t, y: h_det, mode: "lines",
        name: `Detector band ${p.flowHz.toFixed(0)}–${p.fhighHz.toFixed(0)} Hz`,
        hovertemplate: "t=%{x:.4f} s<br>h=%{y:.3e}<extra>band</extra>" }
    ];

    const layout = {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      margin: {l:60,r:20,t:30,b:55},
      xaxis: { title: "Time relative to coalescence (s)", gridcolor: "rgba(255,255,255,0.08)", zerolinecolor:"rgba(255,255,255,0.15)" },
      yaxis: { title: "Strain (arb. scaled)", gridcolor: "rgba(255,255,255,0.08)", zerolinecolor:"rgba(255,255,255,0.15)" },
      font: { color: "#e5e7eb" },
      legend: { orientation: "h", x: 0, y: 1.12 }
    };

    const config = { responsive: true, displaylogo: false };

    if (!initialized) {
      Plotly.newPlot("plot", traces, layout, config);
      initialized = true;
    } else {
      Plotly.react("plot", traces, layout, config);
    }
  }

  // ---------- Events ----------
  sliders.forEach(s => s.addEventListener("input", () => {
    const id = s.id;
    if (id === "flow" || id === "fhigh") $("detector").value = "custom";
    render();
  }));

  $("detector").addEventListener("change", render);
  $("speed").addEventListener("input", render);

  $("play").addEventListener("click", () => {
    const w = window._lastWave;
    if (!w) return;
    const src = $("audsrc").value;
    playAudio(src === "raw" ? w.h : w.h_det, w.fs);
  });

  $("stop").addEventListener("click", stopAudio);

  $("reset").addEventListener("click", () => {
    Object.entries(defaults).forEach(([k,v]) => {
      if ($(k)) $(k).value = v;
    });
    stopAudio();
    render();
  });

  // Initialize defaults
  $("detector").value = defaults.detector;
  $("flow").value = defaults.flow;
  $("fhigh").value = defaults.fhigh;
  $("audsrc").value = defaults.audsrc;
  $("speed").value = defaults.speed;

  render();
})();
</script>
</body>
</html>
